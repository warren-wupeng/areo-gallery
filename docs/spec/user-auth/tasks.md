# 用户认证系统实施计划

## 阶段一：项目基础设置

### 1. Next.js 项目初始化
- [x] 1.1 创建 Next.js 13+ 项目（App Router）
  - 使用 `npx create-next-app@latest` 创建项目
  - 配置 TypeScript 和 ESLint
  - 设置 Tailwind CSS 样式方案
  - 配置 Prettier 代码格式化
  - _需求: 基础架构_

- [ ] 1.2 项目结构设置
  - [x] 1.2.1 创建认证路由组 `app/(auth)/`
    - 创建 `login/`、`register/`、`forgot-password/` 目录
    - 设置认证布局 `layout.tsx`
    - _需求: 需求1, 需求2_
  
  - [x] 1.2.2 创建 API 路由结构 `app/api/auth/`
    - 创建主要认证端点目录
    - 创建验证、密码重置、管理员认证子目录
    - _需求: 需求1, 需求2, 需求3_
  
  - [ ] 1.2.3 创建组件目录结构
    - 创建 `components/ui/` 基础组件目录
    - 创建 `components/auth/` 认证组件目录
    - 创建 `components/layout/` 布局组件目录
    - _需求: 前端架构_

### 2. 依赖包安装和配置
- [ ] 2.1 安装 Supabase 相关依赖
  - [ ] 2.1.1 安装核心依赖
    - `@supabase/supabase-js` - Supabase 客户端
    - `@supabase/auth-helpers-nextjs` - Next.js 认证助手
    - `@supabase/auth-helpers-react` - React 认证助手
    - _需求: Supabase 集成_
  
  - [ ] 2.1.2 安装认证 UI 组件
    - `@supabase/auth-ui-react` - 认证 UI 组件
    - `@supabase/auth-ui-shared` - 共享认证组件
    - _需求: 需求1, 需求2_
  
  - [ ] 2.1.3 安装表单验证和工具库
    - `zod` - 数据验证
    - `react-hook-form` - 表单管理
    - `@hookform/resolvers` - 表单验证解析器
    - _需求: 需求4_

- [ ] 2.2 环境变量配置
  - [ ] 2.2.1 创建环境变量文件
    - 创建 `.env.local` 文件
    - 配置 Supabase 项目 URL 和密钥
    - 配置短信和邮件服务密钥
    - _需求: 部署配置_
  
  - [ ] 2.2.2 配置 TypeScript 环境变量类型
    - 创建 `types/env.d.ts` 文件
    - 定义环境变量类型
    - _需求: 类型安全_

## 阶段二：数据库和认证配置

### 3. Supabase 项目设置
- [ ] 3.1 Supabase 项目初始化
  - [ ] 3.1.1 创建 Supabase 项目
    - 在 Supabase 控制台创建新项目
    - 获取项目 URL 和 API 密钥
    - 配置项目设置
    - _需求: 数据持久化_
  
  - [ ] 3.1.2 配置 Supabase 客户端
    - 创建 `lib/supabase.ts` 客户端配置
    - 配置认证选项（自动刷新、会话持久化）
    - 创建服务端客户端配置
    - _需求: 认证和授权_

### 4. 数据库 Schema 设计
- [ ] 4.1 创建用户相关数据表
  - [ ] 4.1.1 创建用户档案表
    - 创建 `user_profiles` 表
    - 设置与 `auth.users` 的外键关系
    - 添加用户角色、封禁状态等字段
    - _需求: 需求3, 需求4_
  
  - [ ] 4.1.2 创建验证码表
    - 创建 `verification_codes` 表
    - 支持邮箱、手机号、密码重置验证码
    - 设置过期时间和使用状态
    - _需求: 需求1, 需求2_
  
  - [ ] 4.1.3 创建登录尝试记录表
    - 创建 `login_attempts` 表
    - 记录登录尝试、IP 地址、成功状态
    - 用于账号保护和异常检测
    - _需求: 需求4_

- [ ] 4.2 数据库索引和约束
  - [ ] 4.2.1 创建性能优化索引
    - 为用户 ID、联系方式创建索引
    - 为验证码、登录尝试创建复合索引
    - _需求: 性能优化_
  
  - [ ] 4.2.2 设置数据完整性约束
    - 设置唯一约束（用户名、邮箱、手机号）
    - 设置检查约束（角色、状态枚举）
    - _需求: 数据完整性_

### 5. Row Level Security (RLS) 配置
- [ ] 5.1 启用 RLS 策略
  - [ ] 5.1.1 为用户表启用 RLS
    - 启用 `user_profiles` 表的 RLS
    - 创建用户查看和更新自己档案的策略
    - 创建管理员查看所有档案的策略
    - _需求: 需求3_
  
  - [ ] 5.1.2 为验证码表启用 RLS
    - 启用 `verification_codes` 表的 RLS
    - 创建验证码创建和验证的策略
    - _需求: 需求1, 需求2_

## 阶段三：后端 API 开发

### 6. 认证 API 实现
- [ ] 6.1 主要认证端点
  - [ ] 6.1.1 实现登录 API (`POST /api/auth/login`)
    - 验证用户凭据（邮箱/手机号 + 密码）
    - 实现登录失败次数限制和账号锁定
    - 记录登录尝试和 IP 地址
    - 支持"记住我"功能
    - _需求: 需求2_
  
  - [ ] 6.1.2 实现注册 API (`POST /api/auth/register`)
    - 支持邮箱和手机号注册
    - 发送验证码/验证邮件
    - 创建用户档案
    - _需求: 需求1_
  
  - [ ] 6.1.3 实现登出 API (`POST /api/auth/logout`)
    - 清除用户会话
    - 记录登出事件
    - _需求: 需求2_
  
  - [ ] 6.1.4 实现会话检查 API (`GET /api/auth/session`)
    - 检查当前用户会话状态
    - 返回用户信息和档案
    - _需求: 需求3_

- [ ] 6.2 验证码系统 API
  - [ ] 6.2.1 实现验证码发送 API (`POST /api/auth/verify/send`)
    - 生成6位数字验证码
    - 发送短信验证码（手机号）
    - 发送邮件验证码（邮箱）
    - 设置5分钟有效期
    - 限制发送频率（1分钟间隔）
    - _需求: 需求1_
  
  - [ ] 6.2.2 实现验证码确认 API (`POST /api/auth/verify/confirm`)
    - 验证验证码正确性
    - 检查验证码是否过期
    - 标记验证码为已使用
    - 支持注册验证和密码重置验证
    - _需求: 需求1, 需求2_

- [ ] 6.3 密码重置 API
  - [ ] 6.3.1 实现密码重置请求 API (`POST /api/auth/reset-password/request`)
    - 验证用户邮箱/手机号
    - 发送密码重置验证码
    - 记录重置请求
    - _需求: 需求2_
  
  - [ ] 6.3.2 实现密码重置确认 API (`POST /api/auth/reset-password/confirm`)
    - 验证重置验证码
    - 更新用户密码
    - 发送密码重置成功通知
    - _需求: 需求2, 需求4_

- [ ] 6.4 管理员认证 API
  - [ ] 6.4.1 实现管理员验证 API (`POST /api/auth/admin/verify`)
    - 验证管理员密码
    - 授予管理员角色
    - 记录管理员操作日志
    - _需求: 需求3_

### 7. 中间件和路由保护
- [ ] 7.1 认证中间件实现
  - [ ] 7.1.1 创建全局认证中间件
    - 检查用户会话状态
    - 保护需要认证的路由
    - 重定向未认证用户到登录页
    - _需求: 需求3_
  
  - [ ] 7.1.2 实现管理员路由保护
    - 检查用户管理员角色
    - 保护管理员专用路由
    - 重定向非管理员用户
    - _需求: 需求3_

- [ ] 7.2 错误处理和验证
  - [ ] 7.2.1 实现 API 错误处理
    - 创建统一的错误响应格式
    - 处理认证相关错误
    - 记录错误日志
    - _需求: 错误处理_
  
  - [ ] 7.2.2 实现数据验证中间件
    - 使用 Zod 验证请求数据
    - 验证邮箱、手机号格式
    - 验证密码强度
    - _需求: 需求4_

## 阶段四：前端组件开发

### 8. 基础 UI 组件
- [ ] 8.1 创建可复用 UI 组件
  - [ ] 8.1.1 实现表单组件
    - `Input.tsx` - 输入框组件
    - `Button.tsx` - 按钮组件
    - `Form.tsx` - 表单容器组件
    - 支持验证状态和错误提示
    - _需求: UI/UX 要求_
  
  - [ ] 8.1.2 实现反馈组件
    - `LoadingSpinner.tsx` - 加载动画
    - `Modal.tsx` - 模态框组件
    - `Toast.tsx` - 消息提示组件
    - _需求: 用户体验_

- [ ] 8.2 认证相关 UI 组件
  - [ ] 8.2.1 实现认证表单组件
    - `LoginForm.tsx` - 登录表单
    - `RegisterForm.tsx` - 注册表单
    - `VerifyForm.tsx` - 验证码表单
    - `ForgotPasswordForm.tsx` - 忘记密码表单
    - `ResetPasswordForm.tsx` - 重置密码表单
    - _需求: 需求1, 需求2_
  
  - [ ] 8.2.2 实现认证守卫组件
    - `AuthGuard.tsx` - 认证守卫
    - `AdminGuard.tsx` - 管理员守卫
    - `ProtectedRoute.tsx` - 受保护路由
    - _需求: 需求3_

### 9. 认证上下文和状态管理
- [ ] 9.1 认证上下文实现
  - [ ] 9.1.1 创建 AuthProvider 组件
    - 管理全局认证状态
    - 提供认证相关方法
    - 监听认证状态变化
    - _需求: 需求3_
  
  - [ ] 9.1.2 实现认证 Hook
    - `useAuth.ts` - 认证状态 Hook
    - `useUser.ts` - 用户信息 Hook
    - `useSession.ts` - 会话状态 Hook
    - _需求: 状态管理_

- [ ] 9.2 表单状态管理
  - [ ] 9.2.1 实现表单验证
    - 使用 react-hook-form 管理表单状态
    - 使用 Zod 进行数据验证
    - 实现实时验证和错误提示
    - _需求: 需求1, 需求2, 需求4_
  
  - [ ] 9.2.2 实现表单提交处理
    - 处理表单提交状态
    - 显示加载和错误状态
    - 实现表单重置功能
    - _需求: 用户体验_

### 10. 页面组件实现
- [ ] 10.1 认证页面
  - [ ] 10.1.1 实现登录页面 (`app/(auth)/login/page.tsx`)
    - 集成登录表单组件
    - 处理登录成功/失败状态
    - 实现"记住我"功能
    - 添加忘记密码链接
    - _需求: 需求2_
  
  - [ ] 10.1.2 实现注册页面 (`app/(auth)/register/page.tsx`)
    - 支持邮箱和手机号注册选项
    - 集成注册表单组件
    - 处理注册流程状态
    - 添加登录链接
    - _需求: 需求1_
  
  - [ ] 10.1.3 实现验证页面 (`app/(auth)/register/verify/page.tsx`)
    - 集成验证码表单
    - 处理验证成功/失败状态
    - 实现重新发送验证码功能
    - _需求: 需求1_
  
  - [ ] 10.1.4 实现忘记密码页面 (`app/(auth)/forgot-password/page.tsx`)
    - 集成忘记密码表单
    - 处理密码重置请求
    - 显示发送状态
    - _需求: 需求2_
  
  - [ ] 10.1.5 实现密码重置页面 (`app/(auth)/forgot-password/reset/page.tsx`)
    - 集成密码重置表单
    - 验证重置令牌
    - 处理密码更新
    - _需求: 需求2_

- [ ] 10.2 布局组件
  - [ ] 10.2.1 实现认证布局 (`app/(auth)/layout.tsx`)
    - 创建认证页面通用布局
    - 添加品牌标识和导航
    - 响应式设计
    - _需求: UI/UX 要求_
  
  - [ ] 10.2.2 实现受保护布局 (`app/dashboard/layout.tsx`)
    - 集成认证守卫
    - 显示用户信息和导航
    - 处理未认证状态
    - _需求: 需求3_

### 11. 侧边栏和导航组件
- [ ] 11.1 侧边栏组件实现
  - [ ] 11.1.1 实现基础侧边栏 (`components/layout/Sidebar.tsx`)
    - 显示用户头像和基本信息
    - 根据认证状态显示/隐藏功能入口
    - 响应式侧边栏设计
    - _需求: 需求3_
  
  - [ ] 11.1.2 实现用户菜单
    - 用户头像下拉菜单
    - 个人主页、设置、登出选项
    - 管理员专用入口
    - _需求: 需求3_

- [ ] 11.2 头部组件实现
  - [ ] 11.2.1 实现页面头部 (`components/layout/Header.tsx`)
    - 显示页面标题和面包屑
    - 集成用户认证状态
    - 移动端适配
    - _需求: UI/UX 要求_

## 阶段五：集成和优化

### 12. 认证流程集成
- [ ] 12.1 注册流程集成
  - [ ] 12.1.1 邮箱注册流程
    - 邮箱验证 → 设置密码 → 自动登录
    - 处理验证邮件发送和验证
    - 错误处理和用户反馈
    - _需求: 需求1_
  
  - [ ] 12.1.2 手机号注册流程
    - 手机号验证 → 设置密码 → 自动登录
    - 处理短信验证码发送和验证
    - 错误处理和用户反馈
    - _需求: 需求1_

- [ ] 12.2 登录流程集成
  - [ ] 12.2.1 标准登录流程
    - 凭据验证 → 会话创建 → 页面跳转
    - 处理登录失败和账号锁定
    - 实现"记住我"功能
    - _需求: 需求2_
  
  - [ ] 12.2.2 密码重置流程
    - 重置请求 → 验证码验证 → 密码更新
    - 处理重置邮件/短信发送
    - 安全验证和通知
    - _需求: 需求2_

### 13. 安全功能实现
- [ ] 13.1 账号保护功能
  - [ ] 13.1.1 登录失败保护
    - 实现连续失败锁定机制
    - 记录和显示锁定状态
    - 自动解锁功能
    - _需求: 需求4_
  
  - [ ] 13.1.2 异常登录检测
    - IP 地址记录和检测
    - 异常登录提醒
    - 安全日志记录
    - _需求: 需求4_

- [ ] 13.2 密码安全功能
  - [ ] 13.2.1 密码强度验证
    - 实时密码强度检查
    - 密码要求提示
    - 密码确认验证
    - _需求: 需求4_
  
  - [ ] 13.2.2 密码更新功能
    - 当前密码验证
    - 新密码设置
    - 密码更新通知
    - _需求: 需求4_

### 14. 性能优化
- [ ] 14.1 认证状态优化
  - [ ] 14.1.1 会话缓存优化
    - 实现认证状态本地缓存
    - 优化会话恢复性能
    - 减少不必要的 API 调用
    - _需求: 性能要求_
  
  - [ ] 14.1.2 组件懒加载
    - 认证组件按需加载
    - 减少初始包大小
    - 提升页面加载速度
    - _需求: 性能要求_

- [ ] 14.2 用户体验优化
  - [ ] 14.2.1 加载状态优化
    - 实现骨架屏加载
    - 优化加载动画
    - 减少用户等待感知
    - _需求: 用户体验_
  
  - [ ] 14.2.2 错误处理优化
    - 友好的错误提示
    - 错误恢复机制
    - 用户操作指导
    - _需求: 用户体验_

## 阶段六：测试和部署

### 15. 单元测试
- [ ] 15.1 认证组件测试
  - [ ] 15.1.1 表单组件测试
    - 测试输入验证功能
    - 测试表单提交逻辑
    - 测试错误状态显示
    - _需求: 质量保证_
  
  - [ ] 15.1.2 认证上下文测试
    - 测试认证状态管理
    - 测试认证方法调用
    - 测试会话处理
    - _需求: 质量保证_

- [ ] 15.2 API 路由测试
  - [ ] 15.2.1 认证 API 测试
    - 测试登录/注册 API
    - 测试验证码 API
    - 测试密码重置 API
    - _需求: 质量保证_
  
  - [ ] 15.2.2 中间件测试
    - 测试路由保护功能
    - 测试权限验证
    - 测试错误处理
    - _需求: 质量保证_

### 16. 集成测试
- [ ] 16.1 认证流程测试
  - [ ] 16.1.1 注册流程测试
    - 测试邮箱注册完整流程
    - 测试手机号注册完整流程
    - 测试验证码验证流程
    - _需求: 需求1_
  
  - [ ] 16.1.2 登录流程测试
    - 测试标准登录流程
    - 测试密码重置流程
    - 测试账号锁定机制
    - _需求: 需求2_

- [ ] 16.2 权限控制测试
  - [ ] 16.2.1 路由保护测试
    - 测试未认证用户重定向
    - 测试管理员权限验证
    - 测试会话过期处理
    - _需求: 需求3_

### 17. E2E 测试
- [ ] 17.1 用户认证场景测试
  - [ ] 17.1.1 完整用户注册测试
    - 使用 Playwright 测试注册流程
    - 验证用户数据创建
    - 验证自动登录功能
    - _需求: 需求1_
  
  - [ ] 17.1.2 完整用户登录测试
    - 测试登录成功场景
    - 测试登录失败场景
    - 测试密码重置场景
    - _需求: 需求2_

- [ ] 17.2 权限控制场景测试
  - [ ] 17.2.1 页面访问控制测试
    - 测试受保护页面访问
    - 测试管理员页面访问
    - 测试未认证用户重定向
    - _需求: 需求3_

### 18. 部署准备
- [ ] 18.1 生产环境配置
  - [ ] 18.1.1 环境变量配置
    - 配置生产环境 Supabase 密钥
    - 配置生产环境短信/邮件服务
    - 配置生产环境域名和 HTTPS
    - _需求: 部署配置_
  
  - [ ] 18.1.2 数据库迁移
    - 执行生产环境数据库迁移
    - 配置生产环境 RLS 策略
    - 设置生产环境索引
    - _需求: 数据持久化_

- [ ] 18.2 监控和日志
  - [ ] 18.2.1 认证事件监控
    - 配置认证事件日志
    - 设置异常登录告警
    - 配置性能监控
    - _需求: 监控和日志_
  
  - [ ] 18.2.2 错误追踪
    - 配置错误追踪系统
    - 设置关键错误告警
    - 配置用户反馈收集
    - _需求: 质量保证_

### 19. 文档和培训
- [ ] 19.1 技术文档
  - [ ] 19.1.1 API 文档
    - 编写认证 API 接口文档
    - 提供 API 使用示例
    - 记录错误码和处理方式
    - _需求: 文档要求_
  
  - [ ] 19.1.2 组件文档
    - 编写认证组件使用文档
    - 提供组件集成示例
    - 记录最佳实践
    - _需求: 文档要求_

- [ ] 19.2 用户文档
  - [ ] 19.2.1 用户使用指南
    - 编写注册和登录指南
    - 提供密码重置说明
    - 记录常见问题解答
    - _需求: 用户体验_

## 验收标准检查清单

### 需求1：用户注册功能 ✅
- [ ] 支持手机号和邮箱两种注册方式
- [ ] 验证码发送和验证功能正常
- [ ] 密码设置和注册完成流程
- [ ] 注册成功后自动登录
- [ ] 错误处理和用户反馈

### 需求2：用户登录功能 ✅
- [ ] 支持手机号/邮箱和密码登录
- [ ] 登录失败处理和账号锁定
- [ ] "记住我"功能实现
- [ ] 密码重置功能完整
- [ ] 登录状态管理

### 需求3：身份验证与权限控制 ✅
- [ ] 未认证用户重定向到登录页
- [ ] 侧边栏根据认证状态显示功能
- [ ] 登录状态过期自动处理
- [ ] 管理员权限验证
- [ ] 账号封禁处理

### 需求4：密码安全与账号保护 ✅
- [ ] 密码强度验证（8位+字母数字）
- [ ] HTTPS 加密传输
- [ ] 密码重置通知
- [ ] 异常登录检测和提醒
- [ ] 密码修改验证

## 项目里程碑

- **里程碑1**: 项目基础设置完成（阶段一、二）
- **里程碑2**: 后端 API 开发完成（阶段三）
- **里程碑3**: 前端组件开发完成（阶段四）
- **里程碑4**: 集成测试完成（阶段五）
- **里程碑5**: 部署上线完成（阶段六）

这个实施计划提供了完整的用户认证系统开发路径，涵盖了从项目初始化到部署上线的所有关键步骤，确保所有需求都得到充分实现和测试。
